
{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Your Listening History</h2>
  <button id="enrich-btn" class="btn btn-warning mb-3">Enrich Missing Lyrics</button>

  <!-- Modal -->
  <div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="progressModalLabel">Enriching Lyrics</h5>
        </div>
        <div class="modal-body">
          <p>Processed: <span id="processed-count">0</span> / <span id="total-count">?</span></p>
          <p>Successful: <span id="success-count">0</span></p>
          <div class="progress mb-2">
            <div id="progress-bar" class="progress-bar progress-bar-striped bg-success" role="progressbar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </div>
        <div class="modal-footer" id="modal-close-btn-wrapper">
          <button type="button" class="btn btn-secondary" id="modal-close-btn">Close</button>
        </div>
      </div>
    </div>
  </div>

  {% if history %}
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Title</th>
          <th>Artist</th>
          <th>Album</th>
          <th>Played At</th>
          <th>Lyrics?</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in history %}
        <tr>
          <td>{{ entry.title }}</td>
          <td>{{ entry.artist }}</td>
          <td>{{ entry.album or '' }}</td>
          <td>{{ entry.play_datetime or '' }}</td>
          <td>{{ '✔️' if entry.lyrics else '❌' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No listening history found.</p>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mt-3">
    <form method="get" class="d-flex align-items-center">
      <input type="hidden" name="page" value="{{ page }}">
      <label for="per_page" class="me-2">Entries per page:</label>
      <select id="per_page" name="per_page" class="form-select w-auto" onchange="this.form.submit()">
        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
      </select>
    </form>

    <nav>
      <ul class="pagination mb-0">
        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('history.view_history', page=pagination.prev_num, per_page=per_page) }}">Previous</a>
        </li>
        <li class="page-item disabled"><span class="page-link">Page {{ page }}</span></li>
        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('history.view_history', page=pagination.next_num, per_page=per_page) }}">Next</a>
        </li>
      </ul>
    </nav>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{{ url_for('static', filename='js/enrich.js') }}"></script>
{% endblock %}
